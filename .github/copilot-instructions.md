## نظرة عامة على المستودع والهدف السريع

هذا المستودع هو تطبيق للكتابة بالصوت يعمل محلياً ويركز على تحويل الكلام العربي إلى نص. الأهداف الرئيسية لوكيل الذكاء الاصطناعي البرمجي هي: الحفاظ على عمل التطبيق عبر جميع المحركات (Vosk، Whisper، Google)، الحفاظ على التسجيل الفوري منخفض الكمون، وتجنب كسر ملفات Batch المساعدة الخاصة بنظام Windows.

## من أين تبدأ (الملفات الرئيسية)

- `main_advanced.py` — ربط التطبيق وتسلسل البدء. يهيئ `ModelManager` و `SpeechRecognizer` و `AutoTyper` و `VoiceTypingGUI`.
- `speech_recognizer.py` — منطق التعرف المركزي (Whisper، Vosk، Google). يحتوي على احتياطيات واعية بالمنصة والاعتماديات ومساران سريعان: مسار ذاكرة Vosk والاحتياطيات المبنية على الملفات.
- `model_manager.py` — يحمّل ويحدد موقع نماذج Vosk عبر مسارات بحث متعددة. مفيد لإضافة لغات أو تغيير منطق البحث عن النماذج.
- `auto_typer.py` — (يستخدم بواسطة `main_advanced.py`) يحتوي على منطق الكتابة (keyboard مقابل pyautogui). اضبط التأخيرات هنا للتوازن بين الكمون والموثوقية.
- `config.py` — قيم الإعدادات العامة المستخدمة من قبل جميع المكونات (المحرك، معدل العينات، تأخير الكتابة، مجلد النماذج).
- `README_*.md` — أنماط التثبيت والتشغيل؛ استخدمها لإعادة إنتاج سير عمل المطورين المتوقع والتعليمات الخاصة بالمنصة (توجد ملفات BAT لنظام Windows: `START.bat`، `FIX_ALL.bat`).

## البنية المعمارية الشاملة (مختصرة)

- **ModelManager**: اكتشاف وتحميل النماذج. يعيد المسارات المحلية لنماذج Vosk.
- **SpeechRecognizer**: محركات قابلة للتوصيل. المسار المفضل أثناء التشغيل: Vosk (محلي، منخفض الكمون) -> Whisper (محلي، دقة أعلى، أثقل) -> Google SR (احتياطي عبر الإنترنت).
- **AutoTyper**: يحول النص المُتعرف عليه إلى ضغطات مفاتيح اصطناعية؛ يُعد عبر `config.py` ويُنشأ في `main_advanced.py`.
- **GUI (VoiceTypingGUI)**: تفاعلات المستخدم (تحميل النماذج، بدء/إيقاف التسجيل) وتشغيل حلقات التعرف في الخلفية.

**تدفق البيانات:**
- الواجهة الرسومية تشغل التسجيل -> `SpeechRecognizer.listen_continuous` يجمع الإطارات -> إما معرِّف ذاكرة Vosk أو معرِّف مبني على ملف WAV مؤقت -> استدعاء نص -> `AutoTyper` يكتب في التطبيق النشط.

**لماذا تم هيكلة الأمور بهذه الطريقة:**
- متطلبات الكمون المنخفض تدفع استخدام مسار ذاكرة Vosk ومخازن إطارات صغيرة (انظر `speech_recognizer.py` حيث تُقرأ إطارات بحجم 2000 ويُستخدم مسار الذاكرة).
- توجد مواقع بحث متعددة و `ModelManager` لأن المستخدمين قد يضعون النماذج في مجلدات مختلفة أو يستخدمون ذاكرة التخزين المؤقت على مستوى النظام (اكتشاف قوي للنماذج يقلل من مشاكل الدعم).

## سير عمل المطورين والأوامر المهمة

- **تشغيل سريع (Windows)**: انقر نقراً مزدوجاً على `START.bat` أو شغّل `python main_advanced.py` من جذر المستودع.
- **فحص صحي سريع**: شغّل `python run_simple.py` — يطبع هذا توفر Whisper و Vosk و PyAudio ويحاول تشغيل التطبيق مع عرض أخطاء مفيدة.
- **تحميل نماذج Vosk برمجياً**: استخدم `model_manager.ModelManager().download_model('ar')` أو السكريبتات `download_and_run.py`/`download_models.py` إن وُجدت.
- **مساعد الإصلاح الشامل**: `python fix_all.py` أو `FIX_ALL.bat` على Windows — احفظ هذه السكريبتات عند تعديل منطق البدء.

## الأعراف والأنماط الخاصة بالمشروع

- **الاعتماديات اختيارية أثناء التشغيل**. الكود يفحص التوفر بشكل متكرر (مثل `try: import whisper` ثم يضبط WHISPER_AVAILABLE). إضافة اعتمادية يجب أن تتضمن استيراداً محمياً ورسالة احتياطية واضحة.
- **اكتشاف النماذج يستخدم مسارات احتياطية متعددة**. عند إضافة دعم لنموذج جديد، حدّث `ModelManager.MODELS` وتأكد من أن فحوصات `get_model_path` تطابق تسمية النموذج.
- **حلقات الوقت الفعلي تقلل النوم بشكل مقصود وتستخدم أحجام مخازن صغيرة** (مثلاً إطارات قراءة الصوت=2000، أحجام القطع المضبوطة في `speech_recognizer.py`) — غيّر هذه بحذر وقس الكمون.
- **سرعة الكتابة مضبوطة في `main_advanced.py`** عبر `AutoTyper(method='keyboard', delay=0.001)`. التأخيرات الافتراضية يمكن تجاوزها بواسطة `config.py`.
- **جميع النصوص المرئية للمستخدم والإعدادات بالعربية**؛ احفظ رسائل CLI/السجلات الجديدة محلية عند تعديل تدفقات المستخدم.

## نقاط التكامل والاعتماديات الخارجية

- **Whisper**: `openai-whisper` (يُستورد كـ `whisper`). عند إضافة ميزات، فضّل فحص `hasattr(whisper, 'load_model')` مثل الكود الموجود.
- **Vosk**: حزمة `vosk`؛ النماذج موجودة في `models/` أو مجلدات ذاكرة التخزين المؤقت للمستخدم. استخدم `ModelManager` لتحميل أو فحص النماذج.
- **PyAudio**: يُستخدم لالتقاط الصوت في الوقت الفعلي — الكود يفترض جهاز إدخال يعمل وصيغة mono بتردد 16kHz.
- **keyboard / pyautogui**: يُستخدمان لإخراج الكتابة. احترم أن keyboard قد يتطلب صلاحيات مرتفعة على بعض المنصات؛ التطبيق يلجأ إلى pyautogui.

## أمثلة ملموسة للمتابعة

- **إضافة لغة Vosk جديدة**: أضف إدخالاً في `ModelManager.MODELS` مع `name` و `url`. ستجده `get_model_path` إذا استُخرج تحت `models/`.
- **استخدام مسار ذاكرة Vosk**: إذا كنت بحاجة لتعرف منخفض الكمون، استدعِ `SpeechRecognizer(engine='vosk')` وتأكد من استخدام `vosk_recognizer.AcceptWaveform` (انظر `_recognize_with_vosk_memory`).
- **إضافة علامة CLI لاختيار المحرك**: اقرأ `config.py` أو أضف علامة argparse في `main_advanced.py` مبكراً، ثم مرر `engine` إلى `SpeechRecognizer`.

## الاختبارات والفحص وبوابات الجودة

- **لا توجد اختبارات آلية في المستودع**. استخدم `run_simple.py` لفحوصات وقت التشغيل السريعة.
- عند تغيير الكود الذي يؤثر على الاستيرادات (whisper/vosk/pyaudio)، شغّل `python run_simple.py` محلياً للتحقق من التدهور الرشيق ورسائل الخطأ.

## ملاحظات السلامة وغير الأهداف

- **لا تحذف حراس try/except الاستيرادية العديدة** — هي مقصودة لدعم الاعتماديات الاختيارية.
- **تجنب إضافة نوم معطّل في حلقة الصوت**؛ تم إزالتها عمداً لتقليل الكمون.

## إذا قمت بإجراء تغييرات، حدّث هذه الملفات

- ملفات `README_*` (تعليمات التثبيت)
- `FIX_WHISPER.bat` و `FIX_ALL.bat` و `START.bat` إذا تغير سير عمل البدء أو الاعتماديات
- `requirements_advanced.txt` إذا أضفت اعتماديات صلبة

---

إذا كان أي قسم غير واضح أو تريد المزيد من الأمثلة (مثلاً مقتطفات كود دقيقة لإضافة نموذج جديد أو تغيير أحجام الإطارات بأمان)، أخبرني بأي جزء وسأوسع التعليمات.
